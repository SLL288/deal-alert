<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Seed Editor | Deal Radar</title>
  <link rel="stylesheet" href="./assets/styles.css" />
</head>
<body>
  <main class="container">
    <section class="hero">
      <h1>Seed listings (offline editor)</h1>
      <p>Load seeds_public.json, edit key fields, and copy the JSON back into data/seeds.json.</p>
      <div class="cta-row">
        <a class="btn secondary" href="./index.html">‚Üê Back to site</a>
      </div>
    </section>

    <section class="section">
      <div class="how">
        <div class="muted" style="margin-bottom:10px;">Edits are local only. Use the exported JSON to update <code>data/seeds.json</code> in the repo.</div>
        <div id="tableWrap"></div>
      </div>
    </section>

    <section class="section">
      <div class="how">
        <h3 style="margin:0 0 8px;">Exported JSON</h3>
        <textarea id="exportBox" rows="12" style="width:100%; padding:10px; border-radius:12px; background:#0c1423; color:var(--text); border:1px solid var(--line);"></textarea>
        <div class="cta-row">
          <button class="btn secondary" type="button" id="copyBtn">Copy JSON</button>
        </div>
      </div>
    </section>
  </main>

<script>
const state = { items: [] };

async function loadSeeds(){
  const ts = Date.now();
  try{
    const r = await fetch(`./seeds_public.json?ts=${ts}`, { cache:"no-store" });
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const data = await r.json();
    state.items = Array.isArray(data.items) ? data.items.map(cleanItem) : [];
  }catch(err){
    console.error("Failed to load seeds_public.json", err);
    state.items = [{
      url:"https://www.realtor.ca/real-estate/29123637/15210-82-avenue-surrey",
      title:"15210 82 Avenue, Surrey, BC",
      city:"Surrey",
      address:"15210 82 Avenue",
      price:0, beds:null, baths:null, sqft:null,
      notes:"Paste key highlights here (optional)",
      bc_assessed_value:null,
      tags:["seed"]
    }];
  }
  renderTable();
  updateExport();
}

function cleanItem(it){
  return {
    url: it.url || "",
    title: it.title || "",
    city: it.city || "",
    address: it.address || "",
    price: it.price ?? 0,
    beds: it.beds ?? null,
    baths: it.baths ?? null,
    sqft: it.sqft ?? null,
    notes: it.notes || "",
    bc_assessed_value: it.bc_assessed_value ?? null,
    tags: Array.isArray(it.tags) ? it.tags : ["seed"]
  };
}

function updateExport(){
  const payload = { items: state.items };
  document.getElementById("exportBox").value = JSON.stringify(payload, null, 2);
}

function renderTable(){
  const wrap = document.getElementById("tableWrap");
  if(!state.items.length){
    wrap.innerHTML = '<div class="empty">No seed items.</div>';
    return;
  }
  const rows = state.items.map((item, idx) => `
    <div class="card" style="gap:8px;">
      <div class="field">
        <label>URL</label>
        <input type="text" value="${item.url}" data-idx="${idx}" data-key="url" />
      </div>
      <div class="field">
        <label>Title</label>
        <input type="text" value="${item.title}" data-idx="${idx}" data-key="title" />
      </div>
      <div class="field">
        <label>City</label>
        <input type="text" value="${item.city}" data-idx="${idx}" data-key="city" />
      </div>
      <div class="field">
        <label>Address</label>
        <input type="text" value="${item.address}" data-idx="${idx}" data-key="address" />
      </div>
      <div class="field">
        <label>Price (0 = fill later)</label>
        <input type="number" value="${item.price || 0}" data-idx="${idx}" data-key="price" />
      </div>
      <div class="field">
        <label>Beds</label>
        <input type="number" step="0.5" value="${item.beds ?? ""}" data-idx="${idx}" data-key="beds" />
      </div>
      <div class="field">
        <label>Baths</label>
        <input type="number" step="0.5" value="${item.baths ?? ""}" data-idx="${idx}" data-key="baths" />
      </div>
      <div class="field">
        <label>Sqft</label>
        <input type="number" value="${item.sqft ?? ""}" data-idx="${idx}" data-key="sqft" />
      </div>
      <div class="field">
        <label>BC Assessed</label>
        <input type="number" value="${item.bc_assessed_value ?? ""}" data-idx="${idx}" data-key="bc_assessed_value" />
      </div>
      <div class="field">
        <label>Notes</label>
        <input type="text" value="${item.notes || ""}" data-idx="${idx}" data-key="notes" />
      </div>
    </div>
  `).join("");
  wrap.innerHTML = rows;
  wrap.querySelectorAll("input").forEach(inp => {
    inp.addEventListener("input", () => {
      const idx = Number(inp.dataset.idx);
      const key = inp.dataset.key;
      let val = inp.value;
      if(["price","beds","baths","sqft","bc_assessed_value"].includes(key)){
        val = val === "" ? null : Number(val);
      }
      state.items[idx][key] = val;
      updateExport();
    });
  });
}

document.getElementById("copyBtn").onclick = () => {
  const box = document.getElementById("exportBox");
  box.select();
  document.execCommand("copy");
};

loadSeeds();
</script>
</body>
</html>
