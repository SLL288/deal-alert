<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Deal Radar | Low-Price Listings</title>
  <meta name="description" content="Find underpriced real estate deals: daily scan of public listings with price drops, below assessment, long DOM, relists, and urgency keywords." />
  <meta property="og:title" content="Deal Radar | Low-Price Listings" />
  <meta property="og:description" content="Daily scan of public listings. Signals: price drops, below assessment, long DOM, relists, urgency keywords." />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="./assets/og.png" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Deal Radar | Low-Price Listings" />
  <meta name="twitter:description" content="Find underpriced listings before others notice." />
  <meta name="twitter:image" content="./assets/og.png" />
  <link rel="stylesheet" href="./assets/styles.css" />
</head>
<body>
  <header>
    <div class="container nav">
      <div class="brand">Deal Radar</div>
      <nav class="nav-links">
        <a class="nav-link" href="#deals">Deals</a>
        <a class="nav-link disabled" href="#" aria-disabled="true" title="Map view coming soon">Map</a>
        <a class="nav-link" href="#how">How it Works</a>
        <a class="nav-link" href="./index_zh.html">中文</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <h1>Find underpriced listings before others notice.</h1>
      <p>Daily scan of public listings. Signals: price drops, below assessment, long DOM, relists, urgency keywords.</p>
      <div class="cta-row">
        <a class="btn" href="./subscribe.html">Get daily alerts (beta)</a>
        <a class="btn secondary" href="#deals">View today’s top deals</a>
      </div>
    </section>

    <section class="strip" id="stats">
      <div class="stat">
        <div class="stat-label">Last run</div>
        <div class="stat-value" id="statRun">—</div>
      </div>
      <div class="stat">
        <div class="stat-label">Listings scanned</div>
        <div class="stat-value" id="statCount">—</div>
      </div>
      <div class="stat">
        <div class="stat-label">Top deals loaded</div>
        <div class="stat-value" id="statDeals">—</div>
      </div>
    </section>

    <section class="section" id="filtersSection">
      <div class="filters">
        <div class="field">
          <label for="cityFilter">City</label>
          <select id="cityFilter">
            <option value="">All cities</option>
          </select>
        </div>
        <div class="field">
          <label for="searchInput">Search</label>
          <input id="searchInput" type="text" placeholder="Address, title…" />
        </div>
        <div class="field">
          <label for="sortSelect">Sort</label>
          <select id="sortSelect">
            <option value="score">Deal score</option>
            <option value="price_asc">Price (low → high)</option>
            <option value="price_desc">Price (high → low)</option>
          </select>
        </div>
        <div class="field">
          <label>Quick filters</label>
          <div class="chips" id="toggleChips"></div>
        </div>
      </div>
    </section>

    <section class="section" id="deals">
      <div class="card empty" id="loading">Loading deals…</div>
      <div class="card error" id="error" style="display:none;">Could not load data.</div>
      <div class="cards" id="dealGrid" style="display:none;"></div>
      <div class="show-more" id="showMore" style="display:none;">
        <button id="showMoreBtn">Show more</button>
      </div>
    </section>

    <section class="section" id="how">
      <div class="how">
        <h3 style="margin:0 0 6px;">How it works</h3>
        <div class="how-steps">
          <div class="step">
            <div aria-hidden="true">
              <svg width="26" height="26" fill="none" viewBox="0 0 24 24"><path stroke="#6de0ff" stroke-width="1.4" d="M4 5h16M4 12h16M4 19h10"/><circle cx="18" cy="19" r="1.5" fill="#6de0ff"/></svg>
            </div>
            <h4>Collect daily</h4>
            <p>We gather public listings and metadata every day.</p>
          </div>
          <div class="step">
            <div aria-hidden="true">
              <svg width="26" height="26" fill="none" viewBox="0 0 24 24"><path stroke="#6de0ff" stroke-width="1.4" d="M12 3v4m0 10v4m9-9h-4M7 12H3"/><circle cx="12" cy="12" r="4.5" stroke="#6de0ff" stroke-width="1.4"/></svg>
            </div>
            <h4>Track changes</h4>
            <p>SQLite history keeps DOM, price moves, and relist signals accurate.</p>
          </div>
          <div class="step">
            <div aria-hidden="true">
              <svg width="26" height="26" fill="none" viewBox="0 0 24 24"><path stroke="#6de0ff" stroke-width="1.4" d="M5 19v-4a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v4"/><circle cx="12" cy="9" r="3.5" stroke="#6de0ff" stroke-width="1.4"/></svg>
            </div>
            <h4>Rank & alert</h4>
            <p>We score deals using drops, assessed gaps, long DOM, relists, and keywords.</p>
          </div>
        </div>
      </div>
    </section>

    <footer>
      <div>Not a brokerage service. Information only. Always verify with the original source.</div>
      <div>Contact: <a href="mailto:hello@example.com">hello@example.com</a></div>
    </footer>
  </main>

<script>
const state = {
  deals: [],
  lastRun: null,
  filters: { city: "", q: "", sort: "score", toggles: new Set() },
  showCount: 30,
  toggleMeta: []
};

const fmtMoney = (n) => new Intl.NumberFormat("en-CA", { style:"currency", currency:"CAD", maximumFractionDigits:0 }).format(n);
const fmtPercent = (v) => `${(v * 100).toFixed(0)}%`;

async function loadJSON(path){
  const ts = Date.now();
  const sep = path.includes("?") ? "&" : "?";
  const r = await fetch(`${path}${sep}ts=${ts}`, { cache: "no-store" });
  if(!r.ok) throw new Error(`Failed ${path}`);
  return await r.json();
}

function normalizeDeal(d){
  const dom = Number.isFinite(d.dom_days) ? d.dom_days : (d.dom_days != null && !isNaN(Number(d.dom_days)) ? Number(d.dom_days) : null);
  const dropRaw = d.price_drop_30d_ratio ?? d.price_drop_ratio ?? null;
  const drop = dropRaw != null && !isNaN(Number(dropRaw)) && Number(dropRaw) > 0 ? Number(dropRaw) : null;
  const below = typeof d.is_below_assessed === "boolean" ? d.is_below_assessed : null;
  const relist = typeof d.is_relist === "boolean" ? d.is_relist : null;
  return {
    listing_id: d.listing_id,
    title: d.title || "Listing",
    address: d.address || "",
    city: d.city || "",
    price: d.price || 0,
    beds: d.beds,
    baths: d.baths,
    sqft: d.sqft,
    bc_assessed_value: d.bc_assessed_value || d.assessed,
    dom_days: dom,
    price_drop_30d_ratio: drop,
    is_relist: relist,
    is_below_assessed: below,
    reasons: d.reasons || [],
    url: d.url || "#",
    score: d.score ?? 0,
  };
}

function buildToggleMeta(deals){
  const base = [
    { id:"below", label:"Below Assessed", field:"is_below_assessed", predicate:(d)=>d.is_below_assessed === true },
    { id:"drop", label:"Price Drop", field:"price_drop_30d_ratio", predicate:(d)=>typeof d.price_drop_30d_ratio === "number" && d.price_drop_30d_ratio > 0 },
    { id:"dom", label:"Long DOM", field:"dom_days", predicate:(d)=>typeof d.dom_days === "number" && d.dom_days > 0 },
    { id:"relist", label:"Relist", field:"is_relist", predicate:(d)=>d.is_relist === true },
  ];
  return base.filter(t => deals.some(t.predicate));
}

function applyFilters(){
  const { city, q, sort, toggles } = state.filters;
  let items = state.deals.filter(d => {
    const matchCity = !city || d.city === city;
    const text = `${d.title} ${d.address} ${d.city}`.toLowerCase();
    const matchQ = !q || text.includes(q.toLowerCase());
    const toggleOk = Array.from(toggles).every(t => {
      if(t === "below") return d.is_below_assessed === true;
      if(t === "drop") return (d.price_drop_30d_ratio || 0) > 0;
      if(t === "dom") return typeof d.dom_days === "number" && d.dom_days > 0;
      if(t === "relist") return d.is_relist === true;
      return true;
    });
    return matchCity && matchQ && toggleOk;
  });

  if(sort === "price_asc") items.sort((a,b)=>a.price-b.price);
  else if(sort === "price_desc") items.sort((a,b)=>b.price-a.price);
  else items.sort((a,b)=> (b.score || 0) - (a.score || 0));

  renderDeals(items);
}

function renderFilters(){
  const cities = [...new Set(state.deals.map(d => d.city).filter(Boolean))].sort();
  const citySel = document.getElementById("cityFilter");
  citySel.innerHTML = `<option value="">All cities</option>` + cities.map(c=>`<option value="${c}">${c}</option>`).join("");
  citySel.onchange = () => { state.filters.city = citySel.value; applyFilters(); };

  const search = document.getElementById("searchInput");
  search.oninput = () => { state.filters.q = search.value; applyFilters(); };

  const sortSel = document.getElementById("sortSelect");
  sortSel.onchange = () => { state.filters.sort = sortSel.value; applyFilters(); };

  const toggleWrap = document.getElementById("toggleChips");
  toggleWrap.innerHTML = "";
  state.toggleMeta.forEach(t => {
    const btn = document.createElement("button");
    btn.className = "chip";
    btn.type = "button";
    btn.textContent = t.label;
    btn.onclick = () => {
      if(state.filters.toggles.has(t.id)) state.filters.toggles.delete(t.id);
      else state.filters.toggles.add(t.id);
      btn.classList.toggle("active");
      applyFilters();
    };
    toggleWrap.appendChild(btn);
  });
}

function badge(text, extraClass=""){
  return `<span class="badge ${extraClass}">${text}</span>`;
}

function renderDeals(list){
  const grid = document.getElementById("dealGrid");
  const showMore = document.getElementById("showMore");
  const loading = document.getElementById("loading");
  const error = document.getElementById("error");
  loading.style.display = "none";
  error.style.display = "none";
  grid.style.display = "grid";

  const total = list.length;
  const slice = list.slice(0, state.showCount);
  if(total === 0){
    grid.innerHTML = `<div class="card empty">No deals matched your filters.</div>`;
    showMore.style.display = "none";
    document.getElementById("statDeals").textContent = "0";
    return;
  }

  grid.innerHTML = slice.map(d => {
    const drops = d.price_drop_30d_ratio != null ? badge(`30d drop ${fmtPercent(d.price_drop_30d_ratio)}`, "negative") : "";
    const dom = d.dom_days != null ? badge(`DOM ${d.dom_days}`) : "";
    const assessed = d.bc_assessed_value ? badge(`Assessed ${fmtMoney(d.bc_assessed_value)}`) : "";
    const relist = d.is_relist ? badge("Relist", "negative") : "";
    const below = d.is_below_assessed ? badge("Below assessed", "positive") : "";
    const bb = [];
    if(d.beds) bb.push(`${d.beds} bd`);
    if(d.baths) bb.push(`${d.baths} ba`);
    if(d.sqft) bb.push(`${d.sqft.toLocaleString()} sqft`);

    const reasons = (d.reasons || []).map(r=>`<li>${r}</li>`).join("");

    return `
      <article class="card">
        <div class="card-top">
          <div>
            <div class="title">${d.title}</div>
            <div class="address">${d.address} · ${d.city}</div>
          </div>
          <div class="price">${fmtMoney(d.price)}</div>
        </div>
        <div class="badge-row">
          ${badge(`Score ${d.score ?? 0}`, "score")}
          ${bb.length ? badge(bb.join(" · ")) : ""}
          ${assessed}
          ${dom}
          ${drops}
          ${relist}
          ${below}
        </div>
        <div class="reasons">
          <strong>Reasons</strong>
          ${reasons ? `<ul>${reasons}</ul>` : `<div class="muted">No reasons provided.</div>`}
        </div>
        <div class="card-actions">
          <a class="link" href="${d.url}" target="_blank" rel="noreferrer">Open source listing</a>
        </div>
      </article>
    `;
  }).join("");

  document.getElementById("statDeals").textContent = total;
  if(total > state.showCount){
    showMore.style.display = "flex";
  } else {
    showMore.style.display = "none";
  }
}

async function main(){
  try{
    const [lastRun, top] = await Promise.all([
      loadJSON("./last_run.json").catch(()=>null),
      loadJSON("./top_deals.json")
    ]);
    state.lastRun = lastRun;
    const deals = (top && top.deals) || [];
    state.deals = deals.map(normalizeDeal);
    state.toggleMeta = buildToggleMeta(state.deals);

    document.getElementById("statRun").textContent = lastRun?.generated_at || "—";
    document.getElementById("statCount").textContent = lastRun?.listing_count ?? "—";

    renderFilters();
    renderDeals(state.deals);
  } catch(err){
    document.getElementById("loading").style.display = "none";
    const el = document.getElementById("error");
    el.textContent = `Could not load data: ${err.message}`;
    el.style.display = "block";
  }
}

document.getElementById("showMoreBtn").onclick = () => { state.showCount += 30; applyFilters(); };
main();
</script>
</body>
</html>
